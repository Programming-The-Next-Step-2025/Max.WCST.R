# Load packages
library(dplyr)
library(tidyr)
library(lme4)
library(lmerTest)
library(ggplot2)
library(readxl)
library(httr)

# 1. Load your data
# Replace 'your_data.csv' with your actual file
# Replace with your direct download URL
url <- "https://onedrive.live.com/download?resid=YOUR_FILE_ID_HERE"

# Download temporarily
GET(url, write_disk(tf <- tempfile(fileext = ".xlsx")))

# Read the file
df <- read_excel(tf)

# 2. Select most complete entry per participant
df <- df %>%
  mutate(completeness = rowSums(!is.na(select(., Q1:Q9)))) %>%
  group_by(participant_id) %>%
  slice_max(completeness, n = 1, with_ties = FALSE) %>%
  ungroup()

# 3. Compute scores per dimension (only if at least 2 out of 3 items are answered)
df <- df %>%
  rowwise() %>%
  mutate(
    control_score = if (sum(!is.na(c_across(Q1:Q3))) >= 2) mean(c_across(Q1:Q3), na.rm = TRUE) else NA_real_,
    su_score = if (sum(!is.na(c_across(Q4:Q6))) >= 2) mean(c_across(Q4:Q6), na.rm = TRUE) else NA_real_,
    consent_score = if (sum(!is.na(c_across(Q7:Q9))) >= 2) mean(c_across(Q7:Q9), na.rm = TRUE) else NA_real_
  ) %>%
  ungroup()

# 4. Compute average scores per scenario
scenario_means <- df %>%
  group_by(scenario_id) %>%
  summarise(
    mean_control = mean(control_score, na.rm = TRUE),
    mean_su = mean(su_score, na.rm = TRUE),
    mean_consent = mean(consent_score, na.rm = TRUE),
    n_raters = n()
  )

# 5. Categorize each scenario as High or Low using cutoff (e.g. 4)
scenario_means <- scenario_means %>%
  mutate(
    control_level = ifelse(mean_control >= 4, "High", "Low"),
    su_level = ifelse(mean_su >= 4, "High", "Low"),
    consent_level = ifelse(mean_consent >= 4, "High", "Low")
  )

# 6. Run ANOVA to test differences between scenarios
model_control <- lmer(control_score ~ factor(scenario_id) + (1 | participant_id), data = df)
model_su <- lmer(su_score ~ factor(scenario_id) + (1 | participant_id), data = df)
model_consent <- lmer(consent_score ~ factor(scenario_id) + (1 | participant_id), data = df)

# 7. ANOVA tables
anova_control <- anova(model_control)
anova_su <- anova(model_su)
anova_consent <- anova(model_consent)

print(anova_control)
print(anova_su)
print(anova_consent)

# 8. Optional: Visualise scenario differences
ggplot(scenario_means, aes(x = factor(scenario_id), y = mean_control)) +
  geom_col() +
  geom_hline(yintercept = 4, linetype = "dashed") +
  labs(title = "Mean Control Ratings per Scenario", y = "Mean Control", x = "Scenario")
